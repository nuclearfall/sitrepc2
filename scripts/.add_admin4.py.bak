#!/usr/bin/env python3
"""
Enrich ua_settlements.csv with oblast (admin_level=4) information,
using ua_admin4.geojson polygons.

Inputs (under DATA_DIR):
  - ua_admin4.geojson
  - ua_settlements.csv

Outputs (under REF_DIR):
  - regions.csv       (one row per oblast, no geometry)
  - settlements.csv   (settlements enriched with region:osm_id & region:name)
"""

import json
from pathlib import Path

import pandas as pd
from shapely.geometry import Point, shape
from shapely.prepared import prep

# -------------------------------------------------------
# CONFIGURATION
# -------------------------------------------------------

DATA_DIR = Path("data/spatial")
REF_DIR = Path("src/sitrepc2/reference")

GEOJSON_FILE = DATA_DIR / "regions.geojson"
SETTLEMENTS_FILE = DATA_DIR / "ua_settlements.csv"

OUTPUT_SETTLEMENTS = REF_DIR / "settlements.enriched.csv"
OUTPUT_REGIONS = REF_DIR / "regions.enriched.csv"


# -------------------------------------------------------
# LOAD REGIONS (oblasts) FROM GEOJSON
# -------------------------------------------------------

def load_regions(geojson_path: Path):
    print(f"Loading oblast polygons from {geojson_path.resolve()}")

    with geojson_path.open("r", encoding="utf-8") as f:
        gj = json.load(f)

    regions_meta = []   # for regions.csv
    region_shapes = []  # for spatial lookup

    for feat in gj["features"]:
        props = feat.get("properties", {})
        geom = feat.get("geometry")

        if not geom:
            continue

        # Basic properties we care about
        region_osm_id = props.get("id")
        region_name_uk = props.get("name")
        region_name_en = props.get("name:en")
        region_name_ru = props.get("name:ru", None)
        region_iso = props.get("ISO3166-2")
        region_wikidata = props.get("wikidata")

        shp = shape(geom)
        prepared = prep(shp)

        regions_meta.append({
            "region:osm_id": region_osm_id,
            "region:name": region_name_en,
            "region:name:uk": region_name_uk,

            "region:wikidata": region_wikidata,
            "region:iso": region_iso,
        })
        if region_name_ru:
            regions_meta["region:name:ru"] = region_name_ru
        region_shapes.append({
            "polygon": shp,
            "prepared": prepared,
            "osm_id": region_osm_id,
            "name_en": region_name_en,
            "name_uk": region_name_uk,
            "wikidata": region_wikidata,
            "iso": region_iso,
        })
        if region_name_ru:
            regions_meta["name:ru"] = region_name_ru
    return regions_meta, region_shapes


# -------------------------------------------------------
# ASSIGN REGIONS TO SETTLEMENTS
# -------------------------------------------------------

def enrich_settlements(settlements_path: Path,
                       region_shapes: list[dict]) -> pd.DataFrame:
    print(f"Loading settlements from {settlements_path.resolve()}")
    df = pd.read_csv(settlements_path)

    results = []

    print("Assigning regions to settlements (pure polygon containment)...")

    for _, row in df.iterrows():
        lat = row["lat"]
        lon = row["lon"]
        point = Point(lon, lat)

        assigned = None

        for r in region_shapes:
            if r["prepared"].contains(point):
                assigned = r
                break

        results.append({
            "osm_id": row["osm_id"],
            "place": row["place"],
            "name": row["name"],
            "name:uk": row["name:uk"],
            "lat": lat,
            "lon": lon,
            "wikidata": row.get("wikidata"),
            "region:osm_id": assigned["osm_id"] if assigned else None,
            "region:name": assigned["name:en"] if assigned else None,
            "region:name:uk": assigned["name"] if assigned else None,
            # True if we successfully assigned a region via polygons,
            # False if no matching oblast was found.
            #"region:confirmed": bool(assigned),
        })
            name_ru = assigned.get("name:ru", None)
            if name_ru:
                results["region:name:ru"] = name_ru
    return pd.DataFrame(results)


# -------------------------------------------------------
# MAIN
# -------------------------------------------------------

def main():
    # Ensure output directory exists
    REF_DIR.mkdir(parents=True, exist_ok=True)

    # Load regions and polygons
    regions_meta, region_shapes = load_regions(GEOJSON_FILE)

    # Save regions metadata (no geometry)
    print(f"Writing regions metadata to {OUTPUT_REGIONS.resolve()}")
    pd.DataFrame(regions_meta).to_csv(OUTPUT_REGIONS, index=False)

    # Enrich settlements
    enriched_df = enrich_settlements(SETTLEMENTS_FILE, region_shapes)

    # Save enriched settlements
    print(f"Writing enriched settlements to {OUTPUT_SETTLEMENTS.resolve()}")
    enriched_df.to_csv(OUTPUT_SETTLEMENTS, index=False)

    print("Done.")


if __name__ == "__main__":
    main()
